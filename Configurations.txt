!London
conf t
router bgp 20000
neighbor 4.20.20.2 remote-as 9000
neighbor 4.20.20.10 remote-as 30000
neighbor 4.20.20.6 remote-as 9000
neighbor 4.20.20.2 default-originate
neighbor 4.20.20.10 default-originate
neighbor 4.20.20.6 default-originate
network 200.100.1.0
network 200.200.1.0
int f1/1
ip add 200.100.1.1 255.255.255.0
ipv6 add 2100:200:100::1/64
no shut
int f2/0
ip add 200.200.1.1 255.255.255.0
ipv6 add 2100:200:200::1/64
no shut
int f1/0
ip add 4.20.20.1 255.255.255.252
ipv6 add 2001:420:0::1/64
no shut
int f0/1
ip add 4.20.20.5 255.255.255.252
ipv6 add 2001:420:4::5/64
no shut
int f0/0
ip add 4.20.20.9 255.255.255.252
ipv6 add 2001:420:8::9/64
no shut
int f2/1
ip add 6.6.6.1 255.255.255.0
ipv6 add 666:666:666::6/64
no shut
int lo0
ip add 10.0.8.1 255.255.255.255
no shut
end
write mem

---------------------------------------------------------------------

!Sintra
conf t
router bgp 30000
neighbor 4.20.20.9 remote-as 20000
neighbor 4.20.20.14 remote-as 9000
network 210.0.1.0
int f1/0
ip add 210.0.1.1 255.255.255.0
ipv6 add 2001:210:0::1/64
no shut
int f0/1
ip add 4.20.20.13 255.255.255.252
ipv6 add 2001:420:12::13/64
no shut
int f0/0
ip add 4.20.20.10 255.255.255.252
ipv6 add 2001:420:8::10/64
no shut
int lo0
ip add 10.0.8.3 255.255.255.255
no shut
end
write mem

---------------------------------------------------------------------

!Porto
conf t
router bgp 9000
bgp default local-preference 300
address-family ipv4 unicast
neighbor 4.20.20.1 remote-as 20000
neighbor 10.0.0.10 remote-as 65300
neighbor 10.0.16.3 remote-as 9000 !Aveiro
neighbor 10.0.16.2 remote-as 9000 !Lisboa
neighbor 10.0.16.2 default-originate
!network 140.1.1.0 TODO
int f1/0
!BGP
ip add 10.0.0.9 255.255.255.252
ipv6 add 2001:200:8::9/64
no shut
int f0/1
ip ospf 1 area 0
ip add 10.0.16.1 255.255.240.0
ipv6 add 2001:200:0::1/64
no shut
int f0/0
ip add 4.20.20.2 255.255.255.252
ipv6 add 2001:420:0::2/64
no shut
int lo0
ip add 10.0.8.2 255.255.255.255
no shut
end

!OSPF redistribute
conf t
router bgp 9000
redistribute ospf 1
router ospf 1
default-information originate always
distance 220

!netS1 traffic
ip route 210.0.1.0 255.255.255.0 10.0.16.2

! BGP non transit ISP X
conf t
ip as-path access-list 1 permit ^$ 
route-map routes-out
match as-path 1
router bgp 9000
address-family ipv4 unicast
neighbor 4.20.20.1 route-map routes-out out
end

! deny private networks
conf t
ip access-list standard fOut-priv-default
10 deny 10.0.0.0 0.0.255.255
100 permit any
router bgp 9000
address-family ipv4 unicast
neighbor 4.20.20.1 distribute-list fOut-priv-default out
end

!L2 traffic
conf t
ip prefix-list PL-L2-TRAFFIC seq 5 permit 200.200.1.0/24
route-map RM-L2-TRAFFIC permit 5
match ip address prefix-list PL-L2-TRAFFIC
set local-preference 300
exit
router bgp 9000
address-family ipv4 unicast
neighbor 10.0.16.3 route-map RM-L2-TRAFFIC out
end

!Lisboa TRAFFIC
conf t
ip prefix-list PL-LISBOA-TRAFFIC seq 5 permit 200.100.1.0/24
ip prefix-list PL-LISBOA-TRAFFIC seq 10 permit 0.0.0.0/0
route-map RM-LISBOA-TRAFFIC permit 10
match ip address prefix-list PL-LISBOA-TRAFFIC
set local-preference 300
exit
router bgp 9000
address-family ipv4 unicast
neighbor 10.0.16.2 route-map RM-LISBOA-TRAFFIC out
end
wr mem

---------------------------------------------------------------------

!Lisboa
conf t
ip cef
mpls traffic-eng tunnels
router bgp 9000
address-family ipv4 unicast
neighbor 4.20.20.5 remote-as 20000
neighbor 4.20.20.13 remote-as 30000
neighbor 10.0.0.14 remote-as 9000 !Oeiras
neighbor 10.0.16.3 remote-as 9000 !Aveiro
neighbor 10.0.16.1 remote-as 9000 !Porto
int f1/0
ip ospf 1 area 0
ip add 192.172.1.1 255.255.255.0
ipv6 add 2001:200:172::1/64
no shut
int f1/1
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 4096 4096 !MPLS
ip add 10.0.16.2 255.255.240.0
ipv6 add 2001:200:0::2/64
no shut
int f2/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 2048 2048 !MPLS
ip add 10.0.0.13 255.255.255.252
ipv6 add 2001:200:12::13/64
no shut
int f0/0
ip add 4.20.20.14 255.255.255.252
ipv6 add 2001:420:12::14/64
no shut
int f0/1
ip add 4.20.20.6 255.255.255.252
ipv6 add 2001:420:4::6/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.2 255.255.255.255
no shut
end

!MPLS
conf t
router ospf 1
mpls traffic-eng area 0                
mpls traffic-eng router-id Loopback 0
end

! BGP non transit ISP X
conf t
ip as-path access-list 1 permit ^$ 
route-map routes-out
match as-path 1
router bgp 9000
address-family ipv4 unicast
neighbor 4.20.20.5 route-map routes-out out
neighbor 4.20.20.13 route-map routes-out out
end
write mem

!OSPF redistribute
conf t
router bgp 9000
redistribute ospf 1
router ospf 1
default-information originate always
distance 220

conf t
ip access-list standard fOut-priv-default
10 deny 10.0.0.0 0.0.255.255
100 permit any
router bgp 9000
address-family ipv4 unicast
neighbor 4.20.20.5 distribute-list fOut-priv-default out
neighbor 4.20.20.13 distribute-list fOut-priv-default out
end

!L2&L3 traffic
conf t
ip prefix-list PL-L2-TRAFFIC seq 10 permit 200.200.1.0/24
ip prefix-list PL-L2-TRAFFIC seq 10 permit 210.0.1.0/24
route-map RM-L2-TRAFFIC permit 10
match ip address prefix-list PL-L2-TRAFFIC
set local-preference 200
exit
router bgp 9000
address-family ipv4 unicast
neighbor 10.0.0.14 route-map RM-L2-TRAFFIC out
neighbor 10.0.16.3 route-map RM-L2-TRAFFIC out
end

!TUNNEL B1-LISBOA
conf t
int tunnel 1
no shut
ip unnumbered Loopback0
tunnel destination 10.0.32.7
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 2048
tunnel mpls traffic-eng path-option 1 explicit name path1
exit
ip explicit-path name path1 enable
next-address 10.0.16.3
next-address 10.0.0.22
end

!Voip TRAFFIC
conf t
access-list 101 permit ip any 130.1.1.0 0.0.0.63
route-map RM-VOIP-TRAFFIC permit 20
match ip address 101
set int tunnel 1
!set int verify-availability
exit
int f0/1
ip policy route-map RM-VOIP-TRAFFIC
end

wr mem



---------------------------------------------------------------------

!EmpC
router bgp 65300
neighbor 10.0.0.9 remote-as 9000
int f0/0
!BGP
ip add 10.0.0.10 255.255.255.252
ipv6 add 2001:200:8::10/64
no shut
int f0/1
ip ospf 1 area 0
ip add 140.1.1.1 255.255.255.0
ipv6 add 2001:140::1/64
no shut
int lo0
ip add 10.0.8.5 255.255.255.255
no shut
end
write mem

---------------------------------------------------------------------

!Aveiro
conf t
ip cef
mpls traffic-eng tunnels
router bgp 9000
neighbor 10.0.16.1 remote-as 9000
neighbor 10.0.16.2 remote-as 9000
int f0/0
ip ospf 1 area 0
ip add 10.0.0.17 255.255.255.252
ipv6 add 2001:200:16::17/64
no shut
int f0/1
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 4096 4096 !MPLS
ip add 10.0.0.21 255.255.255.252
ipv6 add 2001:200:20::21/64
no shut
int f1/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 4096 4096 !MPLS
ip add 10.0.16.3 255.255.240.0
ipv6 add 2001:200:0::3/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.4 255.255.255.255
no shut
end

!MPLS
conf t
router ospf 1
mpls traffic-eng area 0                
mpls traffic-eng router-id Loopback 0
end
write mem


---------------------------------------------------------------------

!Oeiras
conf t
ip cef
mpls traffic-eng tunnels
router bgp 9000
neighbor 10.0.0.13 remote-as 9000
int f0/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 2048 2048 !MPLS
ip add 10.0.0.25 255.255.255.252
ipv6 add 2001:200:24::25/64
no shut
int f0/1
ip ospf 1 area 0
ip add 10.0.0.29 255.255.255.252
ipv6 add 2001:200:28::29/64
no shut
int f1/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 2048 2048 !MPLS
ip add 10.0.0.14 255.255.255.252
ipv6 add 2001:200:12::14/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.5 255.255.255.255
no shut
end

!MPLS
conf t
router ospf 1
mpls traffic-eng area 0                
mpls traffic-eng router-id Loopback 0
end
write mem

---------------------------------------------------------------------

!EmpA1
int f0/0
ip ospf 1 area 0
ip add 10.0.0.18 255.255.255.252
ipv6 add 2001:200:16::18/64
no shut
int f0/1
ip ospf 1 area 0
ip add 120.1.1.1 255.255.255.128
ipv6 add 2001:120:0::1/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.6 255.255.255.255
no shut
end
write mem

---------------------------------------------------------------------

!EmpA2
int f0/0
ip ospf 1 area 0
ip add 10.0.0.30 255.255.255.252
ipv6 add 2001:200:28::30/64
no shut
int f0/1
ip ospf 1 area 0
ip add 120.1.1.129 255.255.255.128
ipv6 add 2001:120:128::129/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.9 255.255.255.255
no shut
end
write mem

---------------------------------------------------------------------

!EmpB1
conf t
ip cef
mpls traffic-eng tunnels
int f0/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 4096 4096 !MPLS
ip add 10.0.0.22 255.255.255.252
ipv6 add 2001:200:20::22/64
no shut
int f0/1
ip ospf 1 area 0
ip add 130.1.1.1 255.255.255.128
ipv6 add 2001:130:0::1/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.7 255.255.255.255
no shut
end

!MPLS
conf t
router ospf 1
mpls traffic-eng area 0                
mpls traffic-eng router-id Loopback 0
end

!TUNNEL B1-LISBOA
conf t
int tunnel 1
no shut
ip unnumbered Loopback0
tunnel destination 10.0.32.2
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 2048
tunnel mpls traffic-eng path-option 1 explicit name path1
exit
ip explicit-path name path1 enable
next-address 10.0.0.21
next-address 10.0.16.2
end

!TUNNEL B1-B2
 conf t
 int tunnel 2
 no shut
 ip unnumbered Loopback0
 tunnel destination 10.0.32.8
 tunnel mode mpls traffic-eng
 tunnel mpls traffic-eng bandwidth 2048
 tunnel mpls traffic-eng path-option 1 explicit name path2
 exit
 ip explicit-path name path2 enable
 next-address 10.0.0.21
 next-address 10.0.16.2
 next-address 10.0.0.14
 next-address 10.0.0.26
 end

!WEB TRAFFIC
conf t
access-list 102 permit tcp 130.1.1.0 0.0.0.127 130.1.1.128 0.0.0.127 eq 80
access-list 102 permit tcp 130.1.1.0 0.0.0.127 130.1.1.128 0.0.0.127 eq 443
route-map RM-WEB-TRAFFIC permit 10
match ip address 102
set int tunnel 2
!set next-hop verify-availability
exit
int f0/1
ip policy route-map RM-WEB-TRAFFIC
end

!Voip TRAFFIC
conf t
access-list 101 permit ip 130.1.1.0 0.0.0.63 any
route-map RM-VOIP-TRAFFIC permit 20
match ip address 101
set int tunnel 1
!set int verify-availability
exit
int f0/1
ip policy route-map RM-VOIP-TRAFFIC
end

write mem

---------------------------------------------------------------------

!EmpB2
conf t
ip cef
mpls traffic-eng tunnels
int f0/0
ip ospf 1 area 0
mpls traffic-eng tunnels    !MPLS
ip rsvp bandwidth 2048 2048 !MPLS
ip add 10.0.0.26 255.255.255.252
ipv6 add 2001:200:24::26/64
no shut
int f0/1
ip ospf 1 area 0
ip add 130.1.1.129 255.255.255.128
ipv6 add 2001:130:128::129/64
no shut
int lo0
ip ospf 1 area 0
ip add 10.0.32.8 255.255.255.255
no shut
end

!MPLS
conf t
router ospf 1
mpls traffic-eng area 0                
mpls traffic-eng router-id Loopback 0
end

!TUNNEL B1-B2
conf t
int tunnel 2
no shut
ip unnumbered Loopback0
tunnel destination 10.0.32.7
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 2048
tunnel mpls traffic-eng path-option 1 explicit name path2
exit
ip explicit-path name path2 enable
next-address 10.0.0.25
next-address 10.0.0.13
next-address 10.0.16.3
next-address 10.0.0.22
end

!WEB TRAFFIC
conf t
access-list 102 permit tcp 130.1.1.128 0.0.0.127 130.1.1.0 0.0.0.127 eq 80
access-list 102 permit tcp 130.1.1.128 0.0.0.127 130.1.1.0 0.0.0.127 eq 443
route-map RM-WEB-TRAFFIC permit 10
match ip address 102
set int tunnel 2
!set int verify-availability
exit
int f0/1
ip policy route-map RM-WEB-TRAFFIC
end

write mem
